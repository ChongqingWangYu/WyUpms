<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wy.upms.system.mapper.SoftwareSysDao">
    <insert id="insertSystemInfo">
        insert into b_system (sys_name)
        value (#{sysName})
    </insert>
    <insert id="insertRoleInfo">
        insert into b_role (sys_id,role_name)
        value (#{sysId},#{roleName})
    </insert>
    <insert id="insertMenuInfo">
        insert into b_system_menu_tree (sys_id,menu_name,menu_level,menu_parent_id)
        value (#{sysId},#{menuName},#{menuLevel},#{menuParentId})
    </insert>
    <insert id="insertPermissionInfo">
        insert into b_permission (user_id,role_id,sys_id,dep_id,menu_id,menu_parent_id,query,edit,export,impower)
        value (#{userId},#{roleId},#{sysId},#{depId},#{menuId},#{menuParentId},#{query},#{edit},#{export},#{impower})
    </insert>
    <insert id="insertDepartmentInfo">
        insert into b_department (sys_id,dep_name)
        value (#{sysId},#{depName})
    </insert>
    <update id="updateRole">
        update b_role set sys_id = #{sysId},role_name = #{roleName}
        where flow_id = #{flowId}
    </update>
    <update id="updateDepartmentInfo">
        update b_department set sys_id = #{sysId},dep_name = #{depName}
        where flow_id = #{flowId}
    </update>
    <update id="updateSoftwareSysInfo">
        update b_system set sys_name = #{sysName}
        where flow_id = #{flowId}
    </update>
    <update id="updateMenu">
        update b_system_menu_tree
        <set>
            <if test="menuName != null and menuName != ''">menu_name = #{menuName},</if>
            <if test="menuLevel != null and menuLevel != ''">menu_level = #{menuLevel},</if>
            <if test="menuParentId != null and menuParentId != ''">menu_parent_id = #{menuParentId},</if>
            <if test="path != null and path != ''">path = #{path},</if>
            <if test="component != null and component != ''">component = #{component},</if>
            <if test="orderNum != null and orderNum != ''">order_num = #{orderNum},</if>
            <if test="perms != null and perms != ''">perms = #{perms},</if>
            <if test="icon != null and icon != ''">icon = #{icon},</if>
        </set>
        where flow_id = #{flowId}
    </update>
    <delete id="deleteRoleById">
        delete from b_role
        where flow_id = #{roleId}
    </delete>
    <delete id="deleteDepartmentById">
        delete from b_department
        where flow_id = #{depId}
    </delete>
    <delete id="deleteSystemById">
        delete from b_system
        where flow_id = #{sysId}
    </delete>
    <delete id="deleteMenuById">
        delete from b_system_menu_tree
        where flow_id = #{menuId}
    </delete>
    <delete id="deletePermissionAndChildren">
        delete from b_permission
        where sys_id = #{sysId} and role_id = #{roleId}
        and menu_id = #{menuId}
    </delete>
    <select id="selectAllRole" resultType="com.wy.sso.user.domain.RoleInfo">
        select r.flow_id,sys_id,role_name,r.create_time,s.sys_name
        from b_role r inner join b_system s on r.sys_id = s.flow_id
    </select>
    <select id="selectAllDepartment" resultType="com.wy.upms.system.domain.DepartmentInfo">
        select d.flow_id,sys_id,dep_name,d.create_time,s.sys_name
        from b_department d inner join b_system s on d.sys_id = s.flow_id
    </select>
    <select id="selectAllSystem" resultType="com.wy.upms.system.domain.SoftwareSysInfo">
        select flow_id,sys_name,create_time
        from b_system
    </select>
    <select id="selectMenuListByParentId" resultType="com.wy.upms.system.domain.MenuInfo">
        select
            m.flow_id,
            m.sys_id,
            menu_name,
            menu_level,
            m.menu_parent_id,
            m.create_time,
            QUERY,
            edit,
            export,
            impower
        from b_system_menu_tree m left join b_permission p ON m.flow_id = p.menu_id
        AND m.sys_id = p.sys_id
        where m.menu_parent_id = #{menuParentId}
        order by m.flow_id
    </select>
    <select id="selectMenuRootNodeList" resultType="com.wy.upms.system.domain.MenuInfo">
        SELECT DISTINCT
        m.flow_id,
        m.sys_id,
        menu_name,
        menu_level,
        m.menu_parent_id,
        m.create_time,
        QUERY,
        edit,
        export,
        impower
        FROM
        b_system_menu_tree m
        LEFT JOIN (
        SELECT
        *
        FROM
        b_permission
        where 1=0
        <if test="roleId != null">or role_id = #{roleId}</if>
        <if test="userId != null">or user_id = #{userId}</if>
        <if test="depId != null">or dep_id = #{depId}</if>
        ) p ON m.flow_id = p.menu_id
        AND m.sys_id = p.sys_id
        WHERE
        m.sys_id = #{sysId} and menu_level = 0
        order by m.flow_id
    </select>
    <select id="selectPermissionInfoByMenuId" resultType="com.wy.upms.system.domain.PermissionInfo">
        select flow_id,user_id,role_id,sys_id,dep_id,menu_id,menu_parent_id,query,edit,export,impower,create_time
         from b_permission
         where menu_parent_id = #{menuId}
    </select>
    <select id="selectAllMenu" resultType="com.wy.upms.system.domain.MenuInfo">
        SELECT
            flow_id,
            sys_id,
            menu_name,
            menu_level,
            path,
            component,
            icon,
            menu_parent_id,
            perms,
            order_num,
            create_time
        FROM
            b_system_menu_tree
        order by order_num
    </select>
    <select id="selectRoleByUser" resultType="com.wy.sso.user.domain.RoleInfo">
        select r.flow_id,sys_id,role_name,r.create_time,s.sys_name
        from b_role r inner join b_user_role ur on r.flow_id=ur.role_id inner join b_system s on r.sys_id=s.flow_id
        where ur.user_id=#{flowId}
    </select>
    <select id="selectPermissionInfoByUser" resultType="com.wy.sso.user.domain.UserPermissionInfo">
        select flow_id,user_id,role_id,sys_id,dep_id,menu_id,menu_parent_id,query,edit,export,impower,create_time
        from b_permission p
        where user_id=#{flowIds}
    </select>
    <select id="selectMenuByUser" resultType="com.wy.upms.system.domain.MenuInfo">
        SELECT
            m.flow_id,
            m.sys_id,
            m.menu_name,
            m.menu_level,
            m.path,
            m.component,
            m.icon,
            m.menu_parent_id,
            m.perms,
            m.order_num,
            m.create_time
        FROM
            b_user u inner join b_user_role ur on u.flow_id = ur.user_id
            inner join b_role r on r.flow_id = ur.role_id
            inner join b_permission p on r.flow_id = p.role_id
            inner join b_system_menu_tree m on m.flow_id = p.menu_id
        where
            u.flow_id = #{flowId}
    </select>
</mapper>
